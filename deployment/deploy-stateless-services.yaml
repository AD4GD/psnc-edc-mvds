---
- name: deploy stateless services
  hosts: edc-connector-instances

  vars:
    horizontal_pod_autoscalers_state: "{{ 'present' if with_stateless_services_horizontal_pod_autoscalers else 'absent' }}"
    horizontal_pod_autoscalers_task_heading: "{{ 'deploy' if with_stateless_services_horizontal_pod_autoscalers else 'purge' }}"

  module_defaults:
    k8s:
      wait: true
      wait_timeout: "{{ k8s_wait_timeout }}"
      state: present
      namespace: "{{ k8s_namespace }}"

  tasks:
    - name: "deploy deployment/{{ application }}-connectorconsumer"
      when: "deploy_connector|bool"
      tags:
        - connector
        - connectorconsumer
        - deployment
      k8s:
        definition:
          apiVersion: v1
          kind: Deployment
          metadata:
            name: "{{ application }}-connectorconsumer"
            labels:
              component: connectorconsumer
              application: "{{ application }}"
          spec:
            progressDeadlineSeconds: "{{ progress_deadline_seconds }}"
            replicas: "{{ initial_replicas }}"
            strategy:
              type: RollingUpdate
            selector:
              matchLabels:
                component: connectorconsumer
                application: "{{ application }}"
            template:
              metadata:
                labels:
                  component: connectorconsumer
                  application: "{{ application }}"
                  image_tag: "{{ stateless_services_image_tag }}"
                  parameters_digest: "{{ (connectorconsumer_configmap_digest + connectorconsumer_secret_digest)|hash('sha1') }}"
              spec:
                serviceAccountName: "run-any-uid"
                ports:
                  - name: "api"
                    containerPort: 29191
                    protocol: "TCP"
                  - name: "management"
                    containerPort: 29193
                    protocol: "TCP"
                  - name: "protocol"
                    containerPort: 29194
                    protocol: "TCP"
                  - name: "public"
                    containerPort: 29291
                    protocol: "TCP"
                  - name: "control"
                    containerPort: 29192
                    protocol: "TCP"
                containers:
                  - name: "connectorconsumer"
                    image: "{{ registry_domain }}/{{ registry_project }}/{{ registry_application }}/connector:{{ stateless_services_image_tag }}"
                    imagePullPolicy: "{{ stateless_services_image_pull_policy }}"
                    securityContext:
                      readOnlyRootFilesystem: false
                      runAsNonRoot: false
#                      runAsUser: 1000
                    resources: "{{ connectorconsumer_resources }}"
                    envFrom:
                      - configMapRef:
                          name: "{{ application }}-connectorconsumer"
                          optional: true
                      - secretRef:
                          name: "{{ application }}-connectorconsumer"
                          optional: true
                    volumeMounts:
                      - name: "connectorconsumer-tmp"
                        mountPath: "/tmp"
                volumes:
                  - name: "connectorconsumer-tmp"
                    emptyDir:
                      medium: "Memory"

    - name: "deploy service/{{ application }}-connectorconsumer"
      when: "deploy_connector"
      tags:
        - connector
        - connectorconsumer
        - service
      k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application }}-connectorconsumer"
            labels:
              application: "{{ application }}"
              component: connectorconsumer
          spec:
            ports:
              - name: "api"
                port: 29191
              - name: "management"
                port: 29193
              - name: "protocol"
                port: 29194
              - name: "public"
                port: 29291
              - name: "control"
                port: 29192
            selector:
              application: "{{ application }}"
              component: connectorconsumer

    - name: "deploy configmap/{{ application }}-consumerdashboard"
      when: "deploy_datadashboard"
      tags:
        - consumerdashboard
        - configmap
      k8s:
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ application }}-consumerdashboard-config"
            labels:
              application: "{{ application }}"
          data:
            app.config.json: |
              {
                "apiKey": "fifi-info-zaneta",
                "managementApiUrl": "https://edc-connector-connectorconsumer-edc-connector.apps.paas-dev.psnc.pl/management",
                "catalogUrl": "https://edc-connector-connectorconsumer-edc-connector.apps.paas-dev.psnc.pl/management",
                "theme": "theme-3"
              }
            nginx.conf: |
              events {}
              http {
                include /etc/nginx/mime.types;
                server {
                  listen 80;
                  server_name localhost;
                  root /usr/share/nginx/html;
                  index index.html;
                  access_log off;
                  location / {
                    try_files $uri $uri/ /index.html;
                  }
                  location /management {
                    proxy_pass https://edc-connector-connectorconsumer-edc-connector.apps.paas-dev.psnc.pl;
                  }
                }
              }

    - name: "deploy deployment/{{ application }}-consumerdashboard"
      when: "deploy_datadashboard|bool"
      tags:
        - consumerdashboard
        - deployment
      k8s:
        definition:
          apiVersion: v1
          kind: Deployment
          metadata:
            name: "{{ application }}-consumerdashboard"
            labels:
              component: consumerdashboard
              application: "{{ application }}"
          spec:
            progressDeadlineSeconds: "{{ progress_deadline_seconds }}"
            replicas: "{{ initial_replicas }}"
            strategy:
              type: RollingUpdate
            selector:
              matchLabels:
                component: consumerdashboard
                application: "{{ application }}"
            template:
              metadata:
                labels:
                  component: consumerdashboard
                  application: "{{ application }}"
                  image_tag: "{{ stateless_services_image_tag }}"
                  parameters_digest: "{{ (consumerdashboard_configmap_digest + consumerdashboard_secret_digest)|hash('sha1') }}"
              spec:
                serviceAccountName: "run-any-uid"
                ports:
                  - name: "www"
                    containerPort: 80
                    protocol: "TCP"
                containers:
                  - name: "consumerdashboard"
                    image: "{{ registry_domain }}/{{ registry_project }}/{{ registry_application }}/data-dashboard:{{ stateless_services_image_tag }}"
                    imagePullPolicy: "{{ stateless_services_image_pull_policy }}"
                    securityContext:
                      readOnlyRootFilesystem: false
                      runAsNonRoot: false
                    #                      runAsUser: 1000
                    resources: "{{ consumerdashboard_resources }}"
                    envFrom:
                      - secretRef:
                          name: "{{ application }}-consumerdashboard"
                          optional: true
                      - configMapRef:
                          name: "{{ application }}-consumerdashboard-config"
                          optional: true
                    volumeMounts:
                      - name: "consumerdashboard-tmp"
                        mountPath: "/tmp"
                      - name: "consumerdashboard-nginx-config"
                        mountPath: "/etc/nginx/nginx.conf"
                        subPath: "nginx.conf"
                      - name: "consumerdashboard-app-config"
                        mountPath: "/usr/share/nginx/html/assets/config/app.config.json"
                        subPath: "app.config.json"
                volumes:
                  - name: "consumerdashboard-tmp"
                    emptyDir:
                      medium: "Memory"
                  - name: "consumerdashboard-nginx-config"
                    configMap:
                      name: "{{ application }}-consumerdashboard-config"
                  - name: "consumerdashboard-app-config"
                    configMap:
                      name: "{{ application }}-consumerdashboard-config"

    - name: "deploy service/{{ application }}-consumerdashboard"
      when: "deploy_datadashboard"
      tags:
        - consumerdashboard
        - service
      k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application }}-consumerdashboard"
            labels:
              application: "{{ application }}"
              component: consumerdashboard
          spec:
            ports:
              - name: "www"
                port: 80
            selector:
              application: "{{ application }}"
              component: consumerdashboard

    - name: "deploy deployment/{{ application }}-connectorprovider"
      when: "deploy_connector|bool"
      tags:
        - connector
        - connectorprovider
        - deployment
      k8s:
        definition:
          apiVersion: v1
          kind: Deployment
          metadata:
            name: "{{ application }}-connectorprovider"
            labels:
              component: connectorprovider
              application: "{{ application }}"
          spec:
            progressDeadlineSeconds: "{{ progress_deadline_seconds }}"
            replicas: "{{ initial_replicas }}"
            strategy:
              type: RollingUpdate
            selector:
              matchLabels:
                component: connectorprovider
                application: "{{ application }}"
            template:
              metadata:
                labels:
                  component: connectorprovider
                  application: "{{ application }}"
                  image_tag: "{{ stateless_services_image_tag }}"
                  parameters_digest: "{{ (connectorprovider_configmap_digest + connectorprovider_secret_digest)|hash('sha1') }}"
              spec:
                serviceAccountName: "run-any-uid"
                ports:
                  - name: "api"
                    containerPort: 19191
                    protocol: "TCP"
                  - name: "management"
                    containerPort: 19193
                    protocol: "TCP"
                  - name: "protocol"
                    containerPort: 19194
                    protocol: "TCP"
                  - name: "public"
                    containerPort: 19291
                    protocol: "TCP"
                  - name: "control"
                    containerPort: 19192
                    protocol: "TCP"
                containers:
                  - name: "connectorprovider"
                    image: "{{ registry_domain }}/{{ registry_project }}/{{ registry_application }}/connector:{{ stateless_services_image_tag }}"
                    imagePullPolicy: "{{ stateless_services_image_pull_policy }}"
                    securityContext:
                      readOnlyRootFilesystem: false
                      runAsNonRoot: false
#                      runAsUser: 1000
                    resources: "{{ connectorprovider_resources }}"
                    envFrom:
                      - configMapRef:
                          name: "{{ application }}-connectorprovider"
                          optional: true
                      - secretRef:
                          name: "{{ application }}-connectorprovider"
                          optional: true
                    volumeMounts:
                      - name: "connectorprovider-tmp"
                        mountPath: "/tmp"
                volumes:
                  - name: "connectorprovider-tmp"
                    emptyDir:
                      medium: "Memory"

    - name: "deploy service/{{ application }}-connectorprovider"
      when: "deploy_connector"
      tags:
        - connector
        - connectorprovider
        - service
      k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application }}-connectorprovider"
            labels:
              application: "{{ application }}"
              component: connectorprovider
          spec:
            ports:
              - name: "api"
                port: 19191
              - name: "management"
                port: 19193
              - name: "protocol"
                port: 19194
              - name: "public"
                port: 19291
              - name: "control"
                port: 19192
            selector:
              application: "{{ application }}"
              component: connectorprovider

    - name: "deploy configmap/{{ application }}-providerdashboard"
      when: "deploy_datadashboard"
      tags:
        - providerdashboard
        - configmap
      k8s:
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ application }}-providerdashboard-config"
            labels:
              application: "{{ application }}"
          data:
            app.config.json: |
              {
                "apiKey": "fifi-info-zaneta",
                "managementApiUrl": "https://edc-connector-connectorprovider-edc-connector.apps.paas-dev.psnc.pl/management",
                "catalogUrl": "https://edc-connector-connectorprovider-edc-connector.apps.paas-dev.psnc.pl/management",
                "theme": "theme-3"
              }
            nginx.conf: |
              events {}
              http {
                include /etc/nginx/mime.types;
                server {
                  listen 80;
                  server_name localhost;
                  root /usr/share/nginx/html;
                  index index.html;
                  access_log off;
                  location / {
                    try_files $uri $uri/ /index.html;
                  }
                  location /management {
                    proxy_pass https://edc-connector-connectorprovider-edc-connector.apps.paas-dev.psnc.pl;
                  }
                }
              }

    - name: "deploy deployment/{{ application }}-providerdashboard"
      when: "deploy_datadashboard|bool"
      tags:
        -providerdashboard
        - deployment
      k8s:
        definition:
          apiVersion: v1
          kind: Deployment
          metadata:
            name: "{{ application }}-providerdashboard"
            labels:
              component: providerdashboard
              application: "{{ application }}"
          spec:
            progressDeadlineSeconds: "{{ progress_deadline_seconds }}"
            replicas: "{{ initial_replicas }}"
            strategy:
              type: RollingUpdate
            selector:
              matchLabels:
                component: providerdashboard
                application: "{{ application }}"
            template:
              metadata:
                labels:
                  component: providerdashboard
                  application: "{{ application }}"
                  image_tag: "{{ stateless_services_image_tag }}"
                  parameters_digest: "{{ (providerdashboard_configmap_digest + providerdashboard_secret_digest)|hash('sha1') }}"
              spec:
                serviceAccountName: "run-any-uid"
                ports:
                  - name: "www"
                    containerPort: 80
                    protocol: "TCP"
                containers:
                  - name: "providerdashboard"
                    image: "{{ registry_domain }}/{{ registry_project }}/{{ registry_application }}/data-dashboard:{{ stateless_services_image_tag }}"
                    imagePullPolicy: "{{ stateless_services_image_pull_policy }}"
                    securityContext:
                      readOnlyRootFilesystem: false
                      runAsNonRoot: false
                    #                      runAsUser: 1000
                    resources: "{{ providerdashboard_resources }}"
                    envFrom:
                      - secretRef:
                          name: "{{ application }}-providerdashboard"
                          optional: true
                      - configMapRef:
                          name: "{{ application }}-providerdashboard-config"
                          optional: true
                    volumeMounts:
                      - name: "providerdashboard-tmp"
                        mountPath: "/tmp"
                      - name: "providerdashboard-nginx-config"
                        mountPath: "/etc/nginx/nginx.conf"
                        subPath: "nginx.conf"
                      - name: "providerdashboard-app-config"
                        mountPath: "/usr/share/nginx/html/assets/config/app.config.json"
                        subPath: "app.config.json"
                volumes:
                  - name: "providerdashboard-tmp"
                    emptyDir:
                      medium: "Memory"
                  - name: "providerdashboard-nginx-config"
                    configMap:
                      name: "{{ application }}-providerdashboard-config"
                  - name: "providerdashboard-app-config"
                    configMap:
                      name: "{{ application }}-providerdashboard-config"

    - name: "deploy service/{{ application }}-providerdashboard"
      when: "deploy_datadashboard"
      tags:
        - providerdashboard
        - service
      k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application }}-providerdashboard"
            labels:
              application: "{{ application }}"
              component: providerdashboard
          spec:
            ports:
              - name: "www"
                port: 80
            selector:
              application: "{{ application }}"
              component: providerdashboard

    - name: "deploy configmap/{{ application }}-datadashboard"
      when: "deploy_datadashboard"
      tags:
        - consumerdashboard
        - configmap
      k8s:
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ application }}-consumerdashboard-config"
            labels:
              application: "{{ application }}"
          data:
            app.config.json: |
              {
                "apiKey": "fifi-info-zaneta",
                "managementApiUrl": "https://consumer-edc-connector.apps.paas-dev.psnc.pl/management" ,
                "catalogUrl": "https://consumer-edc-connector.apps.paas-dev.psnc.pl/management" ,
                "theme": "theme-3"
              }
            nginx.conf: |
              events {}
              http {
                include /etc/nginx/mime.types;
                server {
                  listen 80;
                  server_name edc-connector-consumerdashboard.edc-connector.svc;
                  root /usr/share/nginx/html;
                  index index.html;
                  access_log off;
                  location / {
                    try_files $uri $uri/ /index.html;
                  }
                  location /management {
                    proxy_pass https://consumer-edc-connector.apps.paas-dev.psnc.pl/management;
                  }
                }
              }

    - name: "deploy deployment/{{ application }}-consumerdashboard"
      when: "deploy_datadashboard|bool"
      tags:
        - consumerdashboard
        - deployment
      k8s:
        definition:
          apiVersion: v1
          kind: Deployment
          metadata:
            name: "{{ application }}-consumerdashboard"
            labels:
              component: consumerdashboard
              application: "{{ application }}"
          spec:
            progressDeadlineSeconds: "{{ progress_deadline_seconds }}"
            replicas: "{{ initial_replicas }}"
            strategy:
              type: RollingUpdate
            selector:
              matchLabels:
                component: consumerdashboard
                application: "{{ application }}"
            template:
              metadata:
                labels:
                  component: consumerdashboard
                  application: "{{ application }}"
                  image_tag: "{{ stateless_services_image_tag }}"
                  parameters_digest: "{{ (consumerdashboard_configmap_digest + consumerdashboard_secret_digest)|hash('sha1') }}"
              spec:
                serviceAccountName: "run-any-uid"
                ports:
                  - name: "www"
                    containerPort: 80
                    protocol: "TCP"
                containers:
                  - name: "consumerdashboard"
                    image: "{{ registry_domain }}/{{ registry_project }}/{{ registry_application }}/data-dashboard:{{ stateless_services_image_tag }}"
                    imagePullPolicy: "{{ stateless_services_image_pull_policy }}"
                    securityContext:
                      readOnlyRootFilesystem: false
                      runAsNonRoot: false
                    #                      runAsUser: 1000
                    resources: "{{ consumerdashboard_resources }}"
                    envFrom:
                      - secretRef:
                          name: "{{ application }}-consumerdashboard"
                          optional: true
                      - configMapRef:
                          name: "{{ application }}-consumerdashboard-config"
                          optional: true
                    volumeMounts:
                      - name: "consumerdashboard-tmp"
                        mountPath: "/tmp"
                      - name: "consumerdashboard-nginx-config"
                        mountPath: "/etc/nginx/nginx.conf"
                        subPath: "nginx.conf"
                      - name: "consumerdashboard-app-config"
                        mountPath: "/usr/share/nginx/html/assets/config/app.config.json"
                        subPath: "app.config.json"
                volumes:
                  - name: "consumerdashboard-tmp"
                    emptyDir:
                      medium: "Memory"
                  - name: "consumerdashboard-nginx-config"
                    configMap:
                      name: "{{ application }}-consumerdashboard-config"
                  - name: "consumerdashboard-app-config"
                    configMap:
                      name: "{{ application }}-consumerdashboard-config"

    - name: "deploy service/{{ application }}-consumerdashboard"
      when: "deploy_datadashboard"
      tags:
        - consumerdashboard
        - service
      k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application }}-consumerdashboard"
            labels:
              application: "{{ application }}"
              component: consumerdashboard
          spec:
            ports:
              - name: "www"
                port: 80
            selector:
              application: "{{ application }}"
              component: consumerdashboard

    - name: "deploy deployment/{{ application }}-connectorprovider"
      when: "deploy_connector|bool"
      tags:
        - connector
        - connectorprovider
        - deployment
      k8s:
        definition:
          apiVersion: v1
          kind: Deployment
          metadata:
            name: "{{ application }}-connectorprovider"
            labels:
              component: connectorprovider
              application: "{{ application }}"
          spec:
            progressDeadlineSeconds: "{{ progress_deadline_seconds }}"
            replicas: "{{ initial_replicas }}"
            strategy:
              type: RollingUpdate
            selector:
              matchLabels:
                component: connectorprovider
                application: "{{ application }}"
            template:
              metadata:
                labels:
                  component: connectorprovider
                  application: "{{ application }}"
                  image_tag: "{{ stateless_services_image_tag }}"
                  parameters_digest: "{{ (connectorprovider_configmap_digest + connectorprovider_secret_digest)|hash('sha1') }}"
              spec:
                serviceAccountName: "run-any-uid"
                ports:
                  - name: "api"
                    containerPort: 19191
                    protocol: "TCP"
                  - name: "management"
                    containerPort: 19193
                    protocol: "TCP"
                  - name: "protocol"
                    containerPort: 19194
                    protocol: "TCP"
                  - name: "public"
                    containerPort: 19291
                    protocol: "TCP"
                  - name: "control"
                    containerPort: 19192
                    protocol: "TCP"
                containers:
                  - name: "connectorprovider"
                    image: "{{ registry_domain }}/{{ registry_project }}/{{ registry_application }}/connector:{{ stateless_services_image_tag }}"
                    imagePullPolicy: "{{ stateless_services_image_pull_policy }}"
                    securityContext:
                      readOnlyRootFilesystem: false
                      runAsNonRoot: false
#                      runAsUser: 1000
                    resources: "{{ connectorprovider_resources }}"
                    envFrom:
                      - configMapRef:
                          name: "{{ application }}-connectorprovider"
                          optional: true
                      - secretRef:
                          name: "{{ application }}-connectorprovider"
                          optional: true
                    volumeMounts:
                      - name: "connectorprovider-tmp"
                        mountPath: "/tmp"
                volumes:
                  - name: "connectorprovider-tmp"
                    emptyDir:
                      medium: "Memory"

    - name: "deploy service/{{ application }}-connectorprovider"
      when: "deploy_connector"
      tags:
        - connector
        - connectorprovider
        - service
      k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application }}-connectorprovider"
            labels:
              application: "{{ application }}"
              component: connectorprovider
          spec:
            ports:
              - name: "api"
                port: 19191
              - name: "management"
                port: 19193
              - name: "protocol"
                port: 19194
              - name: "public"
                port: 19291
              - name: "control"
                port: 19192
            selector:
              application: "{{ application }}"
              component: connectorprovider

    - name: "deploy configmap/{{ application }}-providerdashboard"
      when: "deploy_datadashboard"
      tags:
        - providerdashboard
        - configmap
      k8s:
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ application }}-providerdashboard-config"
            labels:
              application: "{{ application }}"
          data:
            app.config.json: |
              {
                "apiKey": "fifi-info-zaneta",
                "managementApiUrl": "https://edc-connector-connectorprovider-edc-connector.apps.paas-dev.psnc.pl/management",
                "catalogUrl": "https://edc-connector-connectorprovider-edc-connector.apps.paas-dev.psnc.pl/management",
                "theme": "theme-3"
              }
            nginx.conf: |
              events {}






    - name: "deploy deployment/{{ application }}-providerdashboard"
      when: "deploy_datadashboard|bool"
      tags:
        -providerdashboard
        - deployment
      k8s:
        definition:
          apiVersion: v1
          kind: Deployment
          metadata:
            name: "{{ application }}-providerdashboard"
            labels:
              component: providerdashboard
              application: "{{ application }}"
          spec:
            progressDeadlineSeconds: "{{ progress_deadline_seconds }}"
            replicas: "{{ initial_replicas }}"
            strategy:
              type: RollingUpdate
            selector:
              matchLabels:
                component: providerdashboard
                application: "{{ application }}"
            template:
              metadata:
                labels:
                  component: providerdashboard
                  application: "{{ application }}"
                  image_tag: "{{ stateless_services_image_tag }}"
                  parameters_digest: "{{ (providerdashboard_configmap_digest + providerdashboard_secret_digest)|hash('sha1') }}"
              spec:
                serviceAccountName: "run-any-uid"
                ports:
                  - name: "www"
                    containerPort: 80
                    protocol: "TCP"
                containers:
                  - name: "providerdashboard"
                    image: "{{ registry_domain }}/{{ registry_project }}/{{ registry_application }}/data-dashboard:{{ stateless_services_image_tag }}"
                    imagePullPolicy: "{{ stateless_services_image_pull_policy }}"
                    securityContext:
                      readOnlyRootFilesystem: false
                      runAsNonRoot: false
                    #                      runAsUser: 1000
                    resources: "{{ providerdashboard_resources }}"
                    envFrom:
                      - secretRef:
                          name: "{{ application }}-providerdashboard"
                          optional: true
                      - configMapRef:
                          name: "{{ application }}-providerdashboard-config"
                          optional: true
                    volumeMounts:
                      - name: "providerdashboard-tmp"
                        mountPath: "/tmp"
                      - name: "providerdashboard-nginx-config"
                        mountPath: "/etc/nginx/nginx.conf"
                        subPath: "nginx.conf"
                      - name: "providerdashboard-app-config"
                        mountPath: "/usr/share/nginx/html/assets/config/app.config.json"
                        subPath: "app.config.json"
                volumes:
                  - name: "providerdashboard-tmp"
                    emptyDir:
                      medium: "Memory"
                  - name: "providerdashboard-nginx-config"
                    configMap:
                      name: "{{ application }}-providerdashboard-config"
                  - name: "providerdashboard-app-config"
                    configMap:
                      name: "{{ application }}-providerdashboard-config"

    - name: "deploy service/{{ application }}-providerdashboard"
      when: "deploy_datadashboard"
      tags:
        - providerdashboard
        - service
      k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ application }}-providerdashboard"
            labels:
              application: "{{ application }}"
              component: providerdashboard
          spec:
            ports:
              - name: "www"
                port: 80
            selector:
              application: "{{ application }}"
              component: providerdashboard

#    - name: "deploy {{ application }} {{ expose_http_kind }}"
#      when: "expose_http_kind != 'none'"
#      tags:
#        - routes
#      vars:
#        expose_http_ip_whitelist: "0.0.0.0/0"
#        expose_http_paths:
#          - path: "/api/"
#            serviceName: "{{ application }}-varnish"
#            servicePort: varnish
#      k8s:
#        definition: "{{ lookup('template', 'expose-http-definitions.yaml', convert_data=True)|from_yaml }}"
