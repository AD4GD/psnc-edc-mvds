- when: postgres_current_pod_name is undefined
  block:
    - name: "fetch image_tag if undefined"
      when: image_tag is undefined or not image_tag
      include_tasks: "tasks/fetch-current-image-tag.yaml"

    - name: "wait for existing postgres container to {{ command_description }}"
      shell: >
        {{ kubectl_command }} -n {{ k8s_namespace }} get pod -l "application={{ application }},component=postgres,image_tag={{ stateless_services_image_tag }}" -o jsonpath='{.items[0].metadata.name}'
      register: postgres_pod_name
      until: postgres_pod_name.rc == 0
      changed_when: false

    - name: "wait for running postgres container to {{ command_description }}"
      shell: >
        {{ kubectl_command }} -n {{ k8s_namespace }} exec {{ postgres_pod_name.stdout }} -c postgres -- manage help
      register: help_result
      until: help_result.rc == 0
      changed_when: false

    - name: "set postgres container identifier for future manage commands"
      set_fact:
        postgres_current_pod_name: "{{ postgres_pod_name.stdout }}"

- name: "{{ command_description }}"
  shell: >
    {{ kubectl_command }} -n {{ k8s_namespace }} exec {{ postgres_current_pod_name }} -c postgres -- {{ command }}
  register: "last_manage_result"
  changed_when: "(changed_when_missing_from_stdout is not defined and changed_when_missing_from_stderr is not defined and (changed_when_never is not defined or not changed_when_never)) or ((changed_when_missing_from_stdout is defined) and (last_manage_result.stdout is not search(changed_when_missing_from_stdout))) or ((changed_when_missing_from_stderr is defined) and (last_manage_result.stderr is not search(changed_when_missing_from_stderr)))"
